<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Blood Pressure By Date - Detailed</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="css/pages.css">
    <link rel="shortcut icon" href="../favicons/favicon.ico">
</head>

<body>
    <h2><a href="index.html">Home</a> | Blood Pressure By Date - Scatter Plot | <a href="index_today.html">Today</a> | <a href="index_sleep.html">Sleep</a></h2>
    
    <div class="button-output-container">
        <button onclick="getNewData()">Get New Data</button>
        <pre id="output"></pre>
    </div>
    
    <label for="start">Start Date:</label>
    <input type="date" id="start">
    <label for="end">End Date:</label>
    <input type="date" id="end">
    <button onclick="changeDateRange(-1)">&#x2212;</button>
    <button onclick="changeDateRange(1)">&#x2b;</button>
    <button onclick="loadData()">Load Data</button>

    <label for="armFilter">Arm:</label>
    <select id="armFilter" onchange="loadData()">
        <option value="both">Both</option>
        <option value="left">Left</option>
        <option value="right">Right</option>
    </select>

    <div id="bp_by_date_chart" style="width:100%;height:600px;"></div>

    <script>
        window.onload = () => {
            // Set default dates
            let endDate = new Date();
            let startDate = new Date();
            startDate.setDate(endDate.getDate() - 2800); // set start xx days earlier than today
            document.getElementById('start').valueAsDate = startDate;
            document.getElementById('end').valueAsDate = endDate;
            loadData(); // Initial update to draw chart based on the default selection
        };

        function loadData() {
            const startDate = document.getElementById('start').value;
            const endDate = document.getElementById('end').value;
            const armFilter = document.getElementById('armFilter').value;

            fetch(`http://localhost:3000/api/bp_detail?start=${startDate}&end=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    // Filter by arm if not 'both'
                    let filteredData = data;
                    if (armFilter !== 'both') {
                        filteredData = data.filter(item => {
                            if (!item.arm) return false;
                            return item.arm.trim().toLowerCase() === armFilter;
                        });
                    }
                    // Debug: log data and filteredData
                    console.log('All data:', data);
                    console.log('Filtered data:', filteredData);

                    // --- Group data by device ---
                    const groupedByDevice = filteredData.reduce((acc, item) => {
                        const device = item.device || 'unknown';
                        if (!acc[device]) {
                            acc[device] = [];
                        }
                        acc[device].push(item);
                        return acc;
                    }, {});

                    // --- Define marker styles for each device ---
                    const deviceSymbols = {
                        'er': 'star',
                        'doctor': 'hexagram',
                        'homedics wrist': 'circle',
                        'pharmacy': 'hourglass',
                        'unknown': 'cross'
                    };

                    const traces = [];
                    // FIX: Use a space ' ' instead of 'T' to combine date and time
                    const allDates = filteredData.map(item => new Date(item.date + ' ' + item.time));

                    // Handle case where there is no data after filtering
                    if (filteredData.length === 0) {
                        Plotly.newPlot('bp_by_date_chart', [], { title: 'Blood Pressure By Date - Detail', yaxis: { range: [40, 181] } });
                        console.log('No data to display for the selected filters.');
                        return;
                    }

                    for (const device in groupedByDevice) {
                        const deviceData = groupedByDevice[device];
                        // FIX: Use a space ' ' instead of 'T' to combine date and time
                        const dates = deviceData.map(item => new Date(item.date + ' ' + item.time));
                        
                        // Systolic trace for this device
                        traces.push({
                            x: dates,
                            y: deviceData.map(item => item.systolic),
                            mode: 'markers',
                            type: 'scatter',
                            name: `Systolic (${device})`,
                            marker: {
                                color: device === 'homedics wrist' ? '#ff4d4d' : 'rgba(255, 77, 77, 0)', // Filled for homedics wrist, transparent for others
                                symbol: deviceSymbols[device] || 'circle',
                                size: device === 'homedics wrist' ? 3 : 8, // Much smaller size for homedics wrist
                                line: device === 'homedics wrist' ? undefined : {
                                    color: '#ff4d4d',
                                    width: 1
                                }
                            }
                        });

                        // Diastolic trace for this device
                        traces.push({
                            x: dates,
                            y: deviceData.map(item => item.diastolic),
                            mode: 'markers',
                            type: 'scatter',
                            name: `Diastolic (${device})`,
                            marker: {
                                color: device === 'homedics wrist' ? '#4d79ff' : 'rgba(77, 121, 255, 0)', // Filled for homedics wrist, transparent for others
                                symbol: deviceSymbols[device] || 'circle',
                                size: device === 'homedics wrist' ? 3 : 8, // Much smaller size for homedics wrist
                                line: device === 'homedics wrist' ? undefined : {
                                    color: '#4d79ff',
                                    width: 1
                                }
                            }
                        });
                    }

                    var layout = {
                        title: 'Blood Pressure By Date - Detail',
                        xaxis: {
                            title: '',
                            type: 'date',
                            tickfont: { size: 10 },
                            tickformat: "%Y-%m-%d",
                            tickangle: -45,
                        },
                        yaxis: {
                            title: 'Blood Pressure (mm Hg)',
                            range: [40, 181], // Adjusted for typical BP range
                        },
                        shapes: [
                            // Systolic normal/high range line (120)
                            {
                                type: 'line',
                                x0: allDates[0],
                                y0: 120,
                                x1: allDates[allDates.length - 1],
                                y1: 120,
                                line: {
                                    color: '#ff4d4d', // Red color
                                    width: 1,
                                    dash: 'dash'
                                }
                            },
                            // Diastolic normal/high range line (80)
                            {
                                type: 'line',
                                x0: allDates[0],
                                y0: 80,
                                x1: allDates[allDates.length - 1],
                                y1: 80,
                                line: {
                                    color: '#4d79ff', // Blue color
                                    width: 1,
                                    dash: 'dash'
                                }
                            }
                        ],
                        annotations: [
                            {
                                x: allDates[allDates.length - 1],
                                y: 120,
                                xref: 'x',
                                yref: 'y',
                                text: '120',
                                showarrow: false,
                                font: {
                                    family: 'Arial',
                                    size: 10,
                                    color: '#ff4d4d'
                                },
                                xanchor: 'right',
                                yanchor: 'bottom'
                            },
                            {
                                x: allDates[allDates.length - 1],
                                y: 80,
                                xref: 'x',
                                yref: 'y',
                                text: '80',
                                showarrow: false,
                                font: {
                                    family: 'Arial',
                                    size: 10,
                                    color: '#4d79ff'
                                },
                                xanchor: 'right',
                                yanchor: 'bottom'
                            }
                        ],
                        legend: {
                            orientation: 'h',
                            y: -0.2
                        }
                    };

                    Plotly.newPlot('bp_by_date_chart', traces, layout);
                })
                .catch(error => console.error('Error loading data:', error));
        }

        function changeDateRange(days) {
            const startInput = document.getElementById('start');
            const endInput = document.getElementById('end');
            let startDate = new Date(startInput.value);
            let endDate = new Date(endInput.value);

            startDate.setDate(startDate.getDate() + days);
            endDate.setDate(endDate.getDate() + days);

            startInput.valueAsDate = startDate;
            endInput.valueAsDate = endDate;

            loadData();
        }
    </script>
    <script src="js/get_new_data.js"></script>
</body>

</html>