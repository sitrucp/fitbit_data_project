<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Sleep Stages By Date - 100% Chart</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="css/pages.css">
    <link rel="shortcut icon" href="../favicons/favicon.ico">
</head>

<body>
    <h2><a href="index.html">Home</a> | Sleep Stages By Date - 100% Chart - <a
            href="page_sleeplog_by_date_stages_abs.html">Absolute Chart</a> | <a href="index_today.html">Today</a> | <a href="index_sleep.html">Sleep</a>
    </h2>
    
    <div class="button-output-container">
        <button onclick="getNewData()">Get New Data</button>
        <pre id="output"></pre>
    </div>
    
    <label for="start">Start Date:</label>
    <input type="date" id="start">
    <label for="end">End Date:</label>
    <input type="date" id="end">
    <button onclick="changeDateRange(-1)">&#x2212;</button>
    <button onclick="changeDateRange(1)">&#x2b;</button>
    <button onclick="loadData()">Load Data</button>

    <div id="sleeplog_by_date_area" style="width:100%;height:600px;"></div>

    <script>
        window.onload = () => {
            let endDate = new Date();
            let startDate = new Date();
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);
            startDate.setDate(endDate.getDate() - 4400); // set start x days earlier than today
            document.getElementById('start').valueAsDate = startDate;
            document.getElementById('end').valueAsDate = endDate;
            loadData();
        };

        function loadData() {
            const startDate = document.getElementById('start').value;
            const endDate = document.getElementById('end').value;

            fetch(`http://localhost:3000/api/sleeplog_summary?start=${startDate}&end=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    // Sort the dates so the x-axis values are in order
                    const sortedDates = data.map(item => item.date).sort((a, b) => new Date(a) - new Date(b));
                    
                    const levelOrder = ['deep', 'light', 'rem', 'awake', 'asleep', 'restless']; // Order of levels
                    const traces = [];

                    levelOrder.forEach(level => {
                        const x = [];
                        const y = [];
                        sortedDates.forEach(date => {
                            const day = data.find(d => d.date === date);
                            let minutes = 0;
                            let totalMinutes = 0;
                            if (day) {
                                // Calculate total minutes from all available stages
                                const deep = day.minutesDeep || 0;
                                const light = day.minutesLight || 0;
                                const rem = day.minutesRem || 0;
                                const awake = day.minutesAwake || 0;
                                const asleep = day.minutesAsleep || 0;
                                const restless = day.minutesRestless || 0;
                                totalMinutes = deep + light + rem + awake + asleep + restless;
                                
                                switch (level) {
                                    case 'deep': minutes = deep; break;
                                    case 'light': minutes = light; break;
                                    case 'rem': minutes = rem; break;
                                    case 'awake': minutes = awake; break;
                                    case 'asleep': minutes = asleep; break;
                                    case 'restless': minutes = restless; break;
                                }
                            }
                            x.push(date);
                            y.push(totalMinutes ? (minutes / totalMinutes) * 100 : 0);
                        });
                        traces.push({
                            x: x,
                            y: y,
                            type: 'bar',
                            name: level,
                            marker: {
                                color: getStageColor(level)
                            }
                        });
                    });

                    var layout = {
                        title: 'Sleeplog Stages By Date - 100% Chart (Summary Values)',
                        yaxis: { title: 'Percent of Total Sleep', ticksuffix: '%' },
                        xaxis: {
                            title: '',
                            type: 'date',
                            tickfont: { size: 10 },
                            tickformat: "%Y-%m-%d", 
                            tickangle: -45
                        },
                        barmode: 'stack'
                    };

                    Plotly.newPlot('sleeplog_by_date_area', traces, layout);
                })
                .catch(error => console.error('Error loading data:', error));
        }

        function getStageColor(stage) {
            switch (stage) {
                case 'deep': return '#333A73';
                case 'light': return '#387ADF';
                case 'rem': return '#50C4ED';
                case 'short_wake': return '#FFDDE8';
                case 'awake': return '#FF407D';
                case 'restless': return '#C0C0C0';
                case 'asleep': return '#808080';
                default: return '#000000';
            }
        }

        function changeDateRange(days) {
            const startInput = document.getElementById('start');
            const endInput = document.getElementById('end');
            let startDate = new Date(startInput.value);
            let endDate = new Date(endInput.value);

            startDate.setDate(startDate.getDate() + days);
            endDate.setDate(endDate.getDate() + days);

            startInput.valueAsDate = startDate;
            endInput.valueAsDate = endDate;

            loadData();
        }
    </script>
</body>

</html>