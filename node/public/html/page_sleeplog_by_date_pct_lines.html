<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Sleep Stages By Date - Percentage Lines</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="js/csv_export.js"></script>
    <link rel="stylesheet" href="css/pages.css">
    <link rel="shortcut icon" href="../favicons/favicon.ico">
</head>

<body>
    <h2><a href="index.html">Home</a> | Sleep Stages By Date - Percentage Lines - <a
            href="page_sleeplog_by_date_stages_100pct.html">Stacked Chart</a> | <a
            href="page_sleeplog_by_date_stages_abs.html">Absolute Chart</a> | <a href="index_today.html">Today</a> | <a href="index_sleep.html">Sleep</a>
    </h2>
    
    <div class="button-output-container">
        <button onclick="getNewData()">Get New Data</button>
        <pre id="output"></pre>
    </div>
    
    <label for="start">Start Date:</label>
    <input type="date" id="start">
    <label for="end">End Date:</label>
    <input type="date" id="end">
    <button onclick="changeDateRange(-1)">&#x2212;</button>
    <button onclick="changeDateRange(1)">&#x2b;</button>
    <label for="rollingWindow">Moving Average:</label>
    <select id="rollingWindow" onchange="loadData()">
        <option value="7">7 days</option>
        <option value="14">14 days</option>
        <option value="30">30 days</option>
    </select>
    <button onclick="loadData()">Load Data</button>
    <button onclick="exportCSV()">Export CSV</button>

    <div id="sleeplog_by_date_area" style="width:100%;height:600px;"></div>

    <script>
        // Global variable to store chart data for CSV export
        let chartData = null;
        
        window.onload = () => {
            let endDate = new Date();
            let startDate = new Date();
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);
            startDate.setDate(endDate.getDate() - 1000); // set start x days earlier than today
            document.getElementById('start').valueAsDate = startDate;
            document.getElementById('end').valueAsDate = endDate;
            loadData();
        };

        function loadData() {
            const startDate = document.getElementById('start').value;
            const endDate = document.getElementById('end').value;

            fetch(`http://localhost:3000/api/sleeplog_summary?start=${startDate}&end=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    // Sort the dates so the x-axis values are in order
                    const sortedDates = data.map(item => item.date).sort((a, b) => new Date(a) - new Date(b));
                    
                    const levelOrder = ['deep', 'light', 'rem', 'awake']; // Order of levels (excluding asleep and restless)
                    const traces = [];

                    // Calculate daily percentages first
                    const dailyPercentages = {};
                    levelOrder.forEach(level => {
                        dailyPercentages[level] = [];
                    });

                    sortedDates.forEach(date => {
                        const day = data.find(d => d.date === date);
                        let totalMinutes = 0;
                        const stageMinutes = {};
                        
                        if (day) {
                            // Calculate total minutes from main sleep stages only (excluding asleep and restless)
                            const deep = day.minutesDeep || 0;
                            const light = day.minutesLight || 0;
                            const rem = day.minutesRem || 0;
                            const awake = day.minutesAwake || 0;
                            totalMinutes = deep + light + rem + awake;
                            
                            stageMinutes.deep = deep;
                            stageMinutes.light = light;
                            stageMinutes.rem = rem;
                            stageMinutes.awake = awake;
                        }

                        levelOrder.forEach(level => {
                            const minutes = stageMinutes[level] || 0;
                            const percentage = totalMinutes ? (minutes / totalMinutes) * 100 : 0;
                            dailyPercentages[level].push({
                                date: date,
                                percentage: percentage
                            });
                        });
                    });

                    // Calculate rolling averages with selected window
                    const rollingWindow = parseInt(document.getElementById('rollingWindow').value) || 7;
                    
                    // Store table data for each date
                    const tableData = [];
                    
                    levelOrder.forEach(level => {
                        const x = [];
                        const y = [];
                        
                        const dailyData = dailyPercentages[level];
                        
                        for (let i = 0; i < dailyData.length; i++) {
                            // Calculate rolling average - need at least rollingWindow days
                            if (i >= rollingWindow - 1) {
                                let sum = 0;
                                let count = 0;
                                
                                // Look back rollingWindow days
                                for (let j = i - rollingWindow + 1; j <= i; j++) {
                                    if (dailyData[j] && !isNaN(dailyData[j].percentage)) {
                                        sum += dailyData[j].percentage;
                                        count++;
                                    }
                                }
                                
                                if (count > 0) {
                                    const date = dailyData[i].date;
                                    const avgValue = Math.round((sum / count) * 10) / 10;
                                    
                                    x.push(date);
                                    y.push(avgValue); // Round to 1 decimal place
                                    
                                    // Store data for table
                                    let tableRow = tableData.find(row => row.date === date);
                                    if (!tableRow) {
                                        tableRow = { date: date };
                                        tableData.push(tableRow);
                                    }
                                    tableRow[level] = avgValue;
                                }
                            }
                        }
                        
                        traces.push({
                            x: x,
                            y: y,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: level,
                            line: {
                                color: getStageColor(level),
                                width: 2
                            },
                            marker: {
                                color: getStageColor(level),
                                size: 3
                            }
                        });
                    });

                    var layout = {
                        title: `Sleeplog Stages By Date - ${rollingWindow}-Day Rolling Average Percentage Lines (Summary Values)`,
                        yaxis: { 
                            title: `Percent of Total Sleep (${rollingWindow}-day avg)`, 
                            ticksuffix: '%'
                        },
                        xaxis: {
                            title: '',
                            type: 'date',
                            tickfont: { size: 10 },
                            tickformat: "%Y-%m-%d", 
                            tickangle: -45
                        },
                        hovermode: 'x unified',
                        showlegend: true
                    };

                    Plotly.newPlot('sleeplog_by_date_area', traces, layout);
                    
                    // Store data for CSV export - use actual trace dates
                    const traceDates = traces.length > 0 ? traces[0].x : [];
                    chartData = {
                        dates: traceDates,
                        sleepStages: levelOrder,
                        traces: traces,
                        rollingWindow: rollingWindow
                    };
                })
                .catch(error => console.error('Error loading data:', error));
        }

        function exportCSV() {
            if (!chartData) {
                alert('No data available to export. Please load data first.');
                return;
            }
            
            // Create the data structure that the table was using (which worked correctly)
            const rowData = [];
            
            // Get dates from the first trace (they should all have the same dates)
            const firstTrace = chartData.traces[0];
            if (!firstTrace || !firstTrace.x || firstTrace.x.length === 0) {
                alert('No chart data available to export.');
                return;
            }
            
            // Create row for each date
            firstTrace.x.forEach((date, dateIndex) => {
                const row = { Date: date };
                
                // Add each sleep stage value
                chartData.sleepStages.forEach(stage => {
                    const trace = chartData.traces.find(t => t.name === stage);
                    if (trace && trace.y && trace.y[dateIndex] !== undefined) {
                        // Map stage names to title case for headers
                        const headerName = stage === 'rem' ? 'REM' : 
                                         stage.charAt(0).toUpperCase() + stage.slice(1);
                        row[headerName] = trace.y[dateIndex];
                    } else {
                        const headerName = stage === 'rem' ? 'REM' : 
                                         stage.charAt(0).toUpperCase() + stage.slice(1);
                        row[headerName] = 0;
                    }
                });
                
                rowData.push(row);
            });
            
            // Create filename with moving average suffix
            const maSuffix = `_${chartData.rollingWindow}ma`;
            const filename = `page_sleeplog_by_date_pct_lines${maSuffix}.csv`;
            
            // Export using shared utility
            exportToCSV({
                data: rowData,
                filename: filename,
                headers: ['Date', 'Deep', 'Light', 'REM', 'Awake'],
                dateColumn: 'Date',
                decimalPlaces: 1
            });
        }

        function getStageColor(stage) {
            switch (stage) {
                case 'deep': return '#333A73';
                case 'light': return '#387ADF';
                case 'rem': return '#50C4ED';
                case 'short_wake': return '#FFDDE8';
                case 'awake': return '#FF407D';
                case 'restless': return '#C0C0C0';
                case 'asleep': return '#808080';
                default: return '#000000';
            }
        }

        function changeDateRange(days) {
            const startInput = document.getElementById('start');
            const endInput = document.getElementById('end');
            let startDate = new Date(startInput.value);
            let endDate = new Date(endInput.value);

            startDate.setDate(startDate.getDate() + days);
            endDate.setDate(endDate.getDate() + days);

            startInput.valueAsDate = startDate;
            endInput.valueAsDate = endDate;

            loadData();
        }

        function getNewData() {
            // This function would typically trigger a data refresh from the backend
            // For now, it just reloads the current data
            loadData();
            document.getElementById('output').textContent = 'Data refreshed at ' + new Date().toLocaleString();
        }
    </script>
</body>

</html>
